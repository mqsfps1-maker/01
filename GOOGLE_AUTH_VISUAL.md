# Google Auth Flow: VisualizaÃ§Ã£o de Dados em Tempo Real

## ğŸ“± O QUE VOCÃŠ VÃŠ NA TELA

### Momento 1: UsuÃ¡rio clica "Entrar com Google"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TagsFlow                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚         Bem-vindo de volta!                 â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ”µ Entrar com Google               â”‚   â”‚ â† User clicks
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚            OU                               â”‚
â”‚                                             â”‚
â”‚  ğŸ“± Telefone: [ _________ ]                 â”‚
â”‚     [Enviar CÃ³digo]                         â”‚
â”‚                                             â”‚
â”‚            OU                               â”‚
â”‚                                             â”‚
â”‚  ğŸ“§ Email: [ _________ ]                    â”‚
â”‚  ğŸ” Senha: [ _________ ]                    â”‚
â”‚     [Entrar com Email]                      â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Momento 2: Google pede permissÃ£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VocÃª estÃ¡ aceitando entrar em      â”‚
â”‚  TagsFlow com sua conta Google      â”‚
â”‚                                    â”‚
â”‚  â˜ GoogleAuth quer acessar:        â”‚
â”‚     â€¢ Email                         â”‚
â”‚     â€¢ Perfil bÃ¡sico                 â”‚
â”‚     â€¢ Foto de perfil                â”‚
â”‚                                    â”‚
â”‚  [Permitir]  [Cancelar]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Momento 3: Redirecionado para app

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    â³ Autenticando...               â”‚
â”‚                                     â”‚
â”‚    Sincronizando com TagsFlow...    â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (apÃ³s 2-3 segundos)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Dashboard                 â”‚
â”‚  Bem-vindo, JoÃ£o Silva! ğŸ‘‹         â”‚
â”‚                                     â”‚
â”‚  [Estoque] [Etiquetas] [Pedidos]   â”‚
â”‚  ...                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ O QUE FICA SALVO NO SUPABASE

### Banco de Dados: `TagsFlow` (seu projeto)

#### 1. Tabela: `auth.users` (Sistema Supabase)

```
â”Œâ”€ auth.users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                        â”‚
â”‚ id          â”‚ 550e8400-e29b-41d4-a716-446655440000   â”‚
â”‚ email       â”‚ joao.silva@empresa.com.br               â”‚
â”‚ created_at  â”‚ 2025-12-10 14:35:42.123456+00           â”‚
â”‚ updated_at  â”‚ 2025-12-10 14:35:42.123456+00           â”‚
â”‚ last_sign_in_at  â”‚ 2025-12-10 14:35:42.123456+00      â”‚
â”‚                  â”‚                                    â”‚
â”‚ encrypted_password    â”‚ NULL â† Sem senha (sÃ³ OAuth)   â”‚
â”‚ email_confirmed_at    â”‚ 2025-12-10 14:35:42+00        â”‚
â”‚                       â”‚ (Google verificou)            â”‚
â”‚ is_sso_user           â”‚ true                          â”‚
â”‚                  â”‚                                    â”‚
â”‚ raw_user_meta_data    â”‚ {                             â”‚
â”‚                       â”‚   "email": "joao...",        â”‚
â”‚                       â”‚   "full_name": "JoÃ£o",       â”‚
â”‚                       â”‚   "picture": "https://...",  â”‚
â”‚                       â”‚   "provider_id": "11836..." â”‚
â”‚                       â”‚ }                             â”‚
â”‚                  â”‚                                    â”‚
â”‚ raw_app_meta_data     â”‚ {                             â”‚
â”‚                       â”‚   "provider": "google",      â”‚
â”‚                       â”‚   "providers": ["google"]    â”‚
â”‚                       â”‚ }                             â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. Tabela: `auth.identities` (VinculaÃ§Ã£o Google)

```
â”Œâ”€ auth.identities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                        â”‚
â”‚ id          â”‚ 118364077523402176152 â† Google ID      â”‚
â”‚ user_id     â”‚ 550e8400-e29b-41d4-a716-446655440000   â”‚
â”‚ provider    â”‚ "google"                                â”‚
â”‚ created_at  â”‚ 2025-12-10 14:35:42.123456+00           â”‚
â”‚ updated_at  â”‚ 2025-12-10 14:35:42.123456+00           â”‚
â”‚                                                        â”‚
â”‚ identity_data         â”‚ {                             â”‚
â”‚                       â”‚   "iss": "https://accounts.. â”‚
â”‚                       â”‚   "sub": "118364077...",      â”‚
â”‚                       â”‚   "email": "joao@...",       â”‚
â”‚                       â”‚   "email_verified": true,    â”‚
â”‚                       â”‚   "name": "JoÃ£o Silva",      â”‚
â”‚                       â”‚   "full_name": "JoÃ£o Silva", â”‚
â”‚                       â”‚   "picture": "https://lh3..  â”‚
â”‚                       â”‚   "provider_id": "11836..."  â”‚
â”‚                       â”‚ }                             â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. Tabela: `public.users` (Sua Tabela)

```
â”Œâ”€ public.users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                        â”‚
â”‚ id              â”‚ 550e8400-e29b-41d4-a716...        â”‚
â”‚ organization_id â”‚ org-12345-abcd-ef01-gh23...        â”‚
â”‚ full_name       â”‚ "JoÃ£o Silva"                        â”‚
â”‚ email           â”‚ "joao.silva@empresa.com.br"         â”‚
â”‚ role            â”‚ "FUNCIONARIO"                       â”‚
â”‚ setor           â”‚ "TI"                                â”‚
â”‚ created_at      â”‚ 2025-12-10 14:35:42+00              â”‚
â”‚ updated_at      â”‚ 2025-12-10 14:35:42+00              â”‚
â”‚                                                        â”‚
â”‚ ui_settings     â”‚ {                                   â”‚
â”‚                 â”‚   "baseTheme": "system",           â”‚
â”‚                 â”‚   "fontFamily": "Inter",           â”‚
â”‚                 â”‚   "accentColor": "indigo",         â”‚
â”‚                 â”‚   "fontSize": 16                   â”‚
â”‚                 â”‚ }                                   â”‚
â”‚                                                        â”‚
â”‚ auth_method     â”‚ "google_oauth" â† Novo campo        â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” VALIDAÃ‡ÃƒO DE SEGURANÃ‡A

### JWT Token (localStorage)

```javascript
// Isto Ã© salvo no navegador apÃ³s login
{
  "iss": "https://seu-projeto.supabase.co",
  "sub": "550e8400-e29b-41d4-a716-446655440000",
  "email": "joao.silva@empresa.com.br",
  "email_confirmed_at": 1733847342,
  "phone_confirmed_at": null,
  "app_metadata": {
    "provider": "google",
    "providers": ["google"]
  },
  "user_metadata": {
    "email": "joao.silva@empresa.com.br",
    "full_name": "JoÃ£o Silva",
    "picture": "https://lh3.googleusercontent.com/..."
  },
  "aud": "authenticated",
  "created_at": 1733847342,
  "confirmed_at": 1733847342,
  "last_sign_in_at": 1733847342,
  "exp": 1733850942,  â† Expira em 1 hora
  "iat": 1733847342,
  "jti": "..."
}
```

---

## ğŸ“Š COMPARAÃ‡ÃƒO: FLUXOS DE AUTENTICAÃ‡ÃƒO

### Fluxo 1: Email + Senha (Tradicional)

```
Login Page
    â†“
[Email, Senha] â†’ POST /auth/v1/token
    â†“
âœ… Senha vÃ¡lida? â†’ Cria JWT + Refresh Token
    â†“
localStorage.setItem('token', JWT)
    â†“
Dashboard
    â†“ (prÃ³ximo login)
POST /auth/v1/token com refresh_token
    â†“
Novo JWT
```

**Dados no Supabase:**
- `auth.users.encrypted_password` = hash bcrypt âœ…
- `auth.identities` = vazio âŒ
- `public.users.auth_method` = "email_password"

---

### Fluxo 2: Google OAuth (Social Login)

```
Login Page
    â†“
[Clica Google] â†’ auth.signInWithOAuth('google')
    â†“
Redireciona para: https://accounts.google.com/oauth...
    â†“
âœ… Google autentica â†’ authorization_code
    â†“
Supabase troca code â†’ access_token do Google
    â†“
Extrai dados: email, name, picture
    â†“
localStorage.setItem('token', JWT)
    â†“
Dashboard
    â†“ (prÃ³ximo login)
[Clica Google] â†’ Detecta sessÃ£o existente â†’ Auto-login
```

**Dados no Supabase:**
- `auth.users.encrypted_password` = NULL âœ…
- `auth.identities.provider` = "google" âœ…
- `auth.identities.identity_data` = dados do Google âœ…
- `public.users.auth_method` = "google_oauth"

---

### Fluxo 3: SMS OTP (Telefone)

```
Login Page
    â†“
[Telefone] â†’ POST /auth/v1/otp
    â†“
Supabase envia SMS com cÃ³digo
    â†“
[CÃ³digo SMS] â†’ POST /auth/v1/verify
    â†“
âœ… CÃ³digo vÃ¡lido? â†’ Cria JWT
    â†“
localStorage.setItem('token', JWT)
    â†“
Dashboard
```

**Dados no Supabase:**
- `auth.users.encrypted_password` = NULL âœ…
- `auth.users.phone` = "+5511987654321" âœ…
- `auth.identities.provider` = "phone" âœ…
- `public.users.auth_method` = "sms_otp"

---

## ğŸ”„ FLUXO HYBRID: Email Convite + Google Auth

### CenÃ¡rio Real: Admin convida JoÃ£o, JoÃ£o aceita com Google

#### Dia 1: Admin envia convite

```
Admin clica [Convidar UsuÃ¡rio]
    â†“
Input: email = "joao.silva@empresa.com.br"
       name = "JoÃ£o Silva"
       setor = "TI"
       role = "FUNCIONARIO"
    â†“
POST /functions/v1/invite-user
    â†“
Supabase gera invite link com token JWT
    â†“
Email enviado:
"Clique aqui para ativar sua conta:
 https://app.tagsflow.com.br/accept-invite?token=eyJ0eXA..."
    â†“
Salvo no Supabase:
auth.users: {
  id: new_uuid,
  email: "joao@...",
  encrypted_password: NULL,
  email_confirmed_at: NULL,
  raw_app_meta_data: { is_invited: true }
}
public.users: {
  id: new_uuid,
  organization_id: admin_org,
  full_name: "JoÃ£o Silva",
  role: "FUNCIONARIO",
  setor: "TI",
  auth_method: NULL  â† Ainda nÃ£o escolheu
}
```

#### Dia 2: JoÃ£o clica no link

```
JoÃ£o clica link de convite
    â†“
PÃ¡gina: SetPasswordPage
"VocÃª foi convidado! Defina uma senha:"
    [Senha] [Confirmar]
    
OU (novo!)
"Preferir Google?"
    [Entrar com Google] â† JoÃ£o escolhe isto
    â†“
redireciona para Google Login
    â†“
Google autentica JoÃ£o
    â†“
Supabase:
1. Detecta user com email "joao@..." jÃ¡ existe
2. Vincula Google ID ao user existente
3. Atualiza auth.users
4. Cria auth.identities
5. Atualiza public.users.auth_method = "google_oauth"
    â†“
JoÃ£o logado! âœ…
```

**Resultado final no Supabase:**

```
auth.users (MESMO UUID):
â”œâ”€ id: new_uuid (mesmo)
â”œâ”€ email: joao@... (mesmo)
â”œâ”€ encrypted_password: NULL (mantÃ©m)
â”œâ”€ email_confirmed_at: 2025-12-11 10:30:00 (Google confirmou)
â”œâ”€ raw_user_meta_data: { email, full_name, picture } (atualizado)
â””â”€ raw_app_meta_data: { provider: "google" } (novo)

auth.identities (NOVO):
â”œâ”€ id: 118364077...
â”œâ”€ user_id: new_uuid (vinculado!)
â”œâ”€ provider: "google"
â””â”€ identity_data: {...}

public.users (MESMO REGISTRO):
â”œâ”€ id: new_uuid (mesmo)
â”œâ”€ full_name: "JoÃ£o Silva" (mantÃ©m)
â”œâ”€ organization_id: admin_org (mantÃ©m)
â””â”€ auth_method: "google_oauth" (atualizado)
```

---

## ğŸ“ LOGS DE AUDITORIA (Recomendado)

Para rastrear logins:

```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users,
  organization_id UUID REFERENCES organizations,
  event_type TEXT,  -- 'login', 'logout', 'invite', etc.
  auth_method TEXT, -- 'email_password', 'google_oauth', 'sms_otp'
  ip_address INET,
  user_agent TEXT,
  status TEXT,  -- 'success', 'failed'
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Exemplo de INSERT (fazer no lado do servidor)
INSERT INTO audit_logs (
  user_id, organization_id, event_type, 
  auth_method, ip_address, status
) VALUES (
  '550e8400-e29b-41d4-a716-446655440000',
  'org-12345-abcd',
  'login',
  'google_oauth',
  INET '192.168.1.100',
  'success'
);
```

---

## ğŸ¯ RESUMO VISUAL

### Antes: SÃ³ Email

```
TagsFlow Database
â”‚
â”œâ”€ auth.users
â”‚  â”œâ”€ id: uuid1
â”‚  â”œâ”€ email: joao@...
â”‚  â”œâ”€ encrypted_password: $2b$12$... âœ…
â”‚  â””â”€ is_sso_user: false
â”‚
â””â”€ public.users
   â”œâ”€ id: uuid1
   â”œâ”€ full_name: JoÃ£o
   â””â”€ auth_method: "email_password"
```

### Depois: Email + Google

```
TagsFlow Database
â”‚
â”œâ”€ auth.users
â”‚  â”œâ”€ id: uuid1
â”‚  â”œâ”€ email: joao@...
â”‚  â”œâ”€ encrypted_password: NULL
â”‚  â”œâ”€ is_sso_user: true
â”‚  â””â”€ raw_user_meta_data: { picture, ... } âœ¨
â”‚
â”œâ”€ auth.identities
â”‚  â”œâ”€ id: 118364077...
â”‚  â”œâ”€ user_id: uuid1
â”‚  â”œâ”€ provider: "google"
â”‚  â””â”€ identity_data: { ... } âœ¨
â”‚
â””â”€ public.users
   â”œâ”€ id: uuid1
   â”œâ”€ full_name: JoÃ£o
   â””â”€ auth_method: "google_oauth" âœ¨
```

---

## âœ… CHECKLIST: DADOS SEGUROS?

- âœ… Senha: NÃ£o armazenada com Google (NULL)
- âœ… Email: Verificado por Google
- âœ… Foto: De fonte confiÃ¡vel (Google)
- âœ… ID Google: Vinculado mas nÃ£o exposto
- âœ… JWT: Expira em 1 hora
- âœ… Refresh Token: Seguro e renovÃ¡vel
- âœ… RLS: Filtra por organization_id automaticamente
- âœ… HTTPS: ObrigatÃ³rio para OAuth

---

## ğŸš€ PRÃ“XIMAS AÃ‡Ã•ES

1. âœ… Adicionar coluna `auth_method` em `public.users`
2. âœ… Testar fluxo Google + Email convite
3. ğŸ”„ Implementar auditoria de logins
4. ğŸ”„ Adicionar aviso LGPD em LoginPage
5. âœ… Validar em produÃ§Ã£o
